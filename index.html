<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./global.css">
    <link rel="stylesheet" href="./index.css">

    <!-- フォント -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+JP&family=Noto+Sans+JP:wght@100..900&family=Zen+Kaku+Gothic+New&display=swap" rel="stylesheet">

    <title>問い合わせ―MGCS公式</title>
</head>
<body>
    <div id="wrapper">
        <div id="board">
            <h1>問い合わせフォーム</h1>
            <p id="please_input">商品IDを入力してください</p>
            <div id="input">
                <input id="textBox" />
                <button onclick="onClick()">送信</button>
            </div>
            <div id="loadingText">
                <p>読み込み中...</p>
            </div>
            <p class="annotation">Megane Goods Creation Studio 公式</p>
        </div>
    </div>
<script>

//sessionStrageかなにかに保存
async function getData(){
  async function sha256(text){
    const uint8  = new TextEncoder().encode(text)
    const digest = await crypto.subtle.digest('SHA-256', uint8)
    return Array.from(new Uint8Array(digest)).map(v => v.toString(16).padStart(2,'0')).join('')
  }
  
  let url = "https://script.google.com/macros/s/AKfycbzAtS5RGigsUMEEkq2aKjGbV5Q27caBYgga4m8S56YVXYkN3vbSybiIRlmf_oWHv-Ja/exec";
  
  const key = document.getElementById("textBox").value
  url += `?password=${await sha256(key)}`
  console.log(key,await sha256(key))
  try {
    const response = await fetch(url)
    if (!response.ok) {
        throw new Error(`レスポンスステータス: ${response.status}`)
    }
    console.log(response)
    const json = await response.json()
    console.log(json)
    return json
  } catch (error) {
    console.error(error.message)
    return "failure!"
  }
}
async function getSubData(){
    console.log("loading...")
    let campaignsData = await fetch("./data/campaigns.json").then(response => {
      if (!response.ok) {
        throw new Error(`Failed to fetch ${jsonFile}. HTTP Status: ${response.status}`);
      }
      return response.json();
    })
    let goodsData = await fetch("./data/goodsData.json").then(response => {
      if (!response.ok) {
        throw new Error(`Failed to fetch ${jsonFile}. HTTP Status: ${response.status}`);
      }
      return response.json();
    })
    const newsData = await fetch("./data/news.json").then(response => {
      if (!response.ok) {
        throw new Error(`Failed to fetch ${jsonFile}. HTTP Status: ${response.status}`);
      }
      return response.json();
    })
    const threadsData = await fetch("./data/threads.json").then(response => {
      if (!response.ok) {
        throw new Error(`Failed to fetch ${jsonFile}. HTTP Status: ${response.status}`);
      }
      return response.json();
    })
    const memberData = await fetch("./data/MGCSMember.json").then(response => {
      if (!response.ok) {
        throw new Error(`Failed to fetch ${jsonFile}. HTTP Status: ${response.status}`);
      }
      return response.json();
    })

    let rep = {
        "goodsData":goodsData,
        "newsData":newsData,
        "campaignsData":campaignsData,
        "threadsData":threadsData,
        "memberData":memberData
    }
    console.log("loaded!",rep)
    return rep
}
async function onClick(){
    document.querySelector("#loadingText > p").textContent = ""
    document.getElementById("loadingText").style.display="inline"
    document.getElementById("input").style.display="none"
    document.getElementById("please_input").style.display="none"

    const data = await getData()
    localStorage.setItem('secretData', JSON.stringify(data))
    localStorage.setItem('newsData', JSON.stringify(data.news))
    localStorage.setItem('campaignsData', JSON.stringify(data.campaigns))
    localStorage.setItem('goodsData', JSON.stringify(data.goodsData))
    localStorage.setItem('threadsData', JSON.stringify(data.threads))
    localStorage.setItem('memberData', JSON.stringify(data.MGCSMember))
    localStorage.setItem('subData', JSON.stringify(data.subData))
    console.log("updated")

    document.querySelector("#loadingText > p").textContent = data.status=="success"?"完了":"入力したIDに対応する商品が見つかりません"
    setTimeout(()=>{
        if(data.status == "success"){
            window.location.href = './questionnaire/'
        }
        document.getElementById("loadingText").style.display="none"
        document.getElementById("input").style.display="flex"
        document.getElementById("please_input").style.display="block"
    },2000)
}
</script>
</body>
</html>